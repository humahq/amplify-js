{"version":3,"file":"openAuthSessionAsync.mjs","sources":["../../../src/apis/openAuthSessionAsync.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { AppState, Linking, Platform, } from 'react-native';\nimport { nativeModule } from '../nativeModule';\nlet appStateListener;\nlet redirectListener;\nexport const openAuthSessionAsync = async (url, redirectUrls, prefersEphemeralSession) => {\n    // enforce HTTPS\n    const httpsUrl = url.replace('http://', 'https://');\n    if (Platform.OS === 'ios') {\n        return openAuthSessionIOS(httpsUrl, redirectUrls, prefersEphemeralSession);\n    }\n    if (Platform.OS === 'android') {\n        return openAuthSessionAndroid(httpsUrl, redirectUrls);\n    }\n};\nconst openAuthSessionIOS = async (url, redirectUrls, prefersEphemeralSession = false) => {\n    const redirectUrl = redirectUrls.find(\n    // take the first non-web url as the deeplink\n    item => !item.startsWith('https://') && !item.startsWith('http://'));\n    return nativeModule.openAuthSessionAsync(url, redirectUrl, prefersEphemeralSession);\n};\nconst openAuthSessionAndroid = async (url, redirectUrls) => {\n    try {\n        const [redirectUrl] = await Promise.all([\n            Promise.race([\n                // wait for app to redirect, resulting in a redirectUrl\n                getRedirectPromise(redirectUrls),\n                // wait for app to return some other way, resulting in null\n                getAppStatePromise(),\n            ]),\n            // open chrome tab\n            nativeModule.openAuthSessionAsync(url),\n        ]);\n        return redirectUrl;\n    }\n    finally {\n        removeAppStateListener();\n        removeRedirectListener();\n    }\n};\nconst getAppStatePromise = () => new Promise(resolve => {\n    // remove any stray listeners before creating new ones\n    removeAppStateListener();\n    let previousState = AppState.currentState;\n    appStateListener = AppState.addEventListener('change', nextAppState => {\n        if (previousState !== 'active' && nextAppState === 'active') {\n            removeAppStateListener();\n            resolve(null);\n        }\n        previousState = nextAppState;\n    });\n});\nconst getRedirectPromise = (redirectUrls) => new Promise(resolve => {\n    // remove any stray listeners before creating new ones\n    removeRedirectListener();\n    redirectListener = Linking.addEventListener('url', event => {\n        if (redirectUrls.some(url => event.url.startsWith(url))) {\n            resolve(event.url);\n        }\n    });\n});\nconst removeAppStateListener = () => {\n    appStateListener?.remove();\n    appStateListener = undefined;\n};\nconst removeRedirectListener = () => {\n    redirectListener?.remove();\n    redirectListener = undefined;\n};\n"],"names":[],"mappings":"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"}