{"version":3,"file":"AWSLexV2Provider.js","sources":["../../../src/lex-v2/AWSLexV2Provider.ts"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.lexProvider = void 0;\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nconst client_lex_runtime_v2_1 = require(\"@aws-sdk/client-lex-runtime-v2\");\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst core_1 = require(\"@aws-amplify/core\");\nconst uuid_1 = require(\"uuid\");\nconst utils_2 = require(\"../utils\");\nconst logger = new core_1.ConsoleLogger('AWSLexV2Provider');\nclass AWSLexV2Provider {\n    constructor() {\n        this._botsCompleteCallback = {};\n        this.defaultSessionId = (0, uuid_1.v4)();\n    }\n    /**\n     * Send a message to a bot\n     * @async\n     * @param {AWSLexV2ProviderOption} botConfig - Bot configuration for sending the message\n     * @param {string | InteractionsMessage} message - message to send to the bot\n     * @return {Promise<InteractionsResponse>} A promise resolves to the response from the bot\n     */\n    async sendMessage(botConfig, message) {\n        // check if credentials are present\n        let session;\n        try {\n            session = await (0, core_1.fetchAuthSession)();\n        }\n        catch (error) {\n            return Promise.reject(new Error('No credentials'));\n        }\n        const { region, aliasId, localeId, botId } = botConfig;\n        const client = new client_lex_runtime_v2_1.LexRuntimeV2Client({\n            region,\n            credentials: session.credentials,\n            customUserAgent: (0, utils_1.getAmplifyUserAgentObject)(),\n        });\n        let response;\n        // common base params for all requests\n        const reqBaseParams = {\n            botAliasId: aliasId,\n            botId,\n            localeId,\n            sessionId: session.identityId ?? this.defaultSessionId,\n        };\n        if (typeof message === 'string') {\n            response = await this._handleRecognizeTextCommand(botConfig, message, reqBaseParams, client);\n        }\n        else {\n            response = await this._handleRecognizeUtteranceCommand(botConfig, message, reqBaseParams, client);\n        }\n        return response;\n    }\n    /**\n     * Attach a onComplete callback function to a bot.\n     * The callback is called once the bot's intent is fulfilled\n     * @param {AWSLexV2ProviderOption} botConfig - Bot configuration to attach the onComplete callback\n     * @param {InteractionsOnCompleteCallback} callback - called when Intent Fulfilled\n     */\n    onComplete({ name }, callback) {\n        this._botsCompleteCallback[name] = callback;\n    }\n    /**\n     * call onComplete callback for a bot if configured\n     */\n    _reportBotStatus(data, { name }) {\n        const sessionState = data?.sessionState;\n        // Check if state is fulfilled to resolve onFullfilment promise\n        logger.debug('postContent state', sessionState?.intent?.state);\n        const callback = this._botsCompleteCallback[name];\n        if (!callback) {\n            return;\n        }\n        switch (sessionState?.intent?.state) {\n            case client_lex_runtime_v2_1.IntentState.READY_FOR_FULFILLMENT:\n            case client_lex_runtime_v2_1.IntentState.FULFILLED:\n                callback(undefined, data);\n                break;\n            case client_lex_runtime_v2_1.IntentState.FAILED:\n                callback(new Error('Bot conversation failed'));\n                break;\n            default:\n                break;\n        }\n    }\n    /**\n     * Format UtteranceCommandOutput's response\n     * decompress attributes\n     * update audioStream format\n     */\n    async _formatUtteranceCommandOutput(data) {\n        return {\n            ...data,\n            messages: await (0, utils_2.unGzipBase64AsJson)(data.messages),\n            sessionState: await (0, utils_2.unGzipBase64AsJson)(data.sessionState),\n            interpretations: await (0, utils_2.unGzipBase64AsJson)(data.interpretations),\n            requestAttributes: await (0, utils_2.unGzipBase64AsJson)(data.requestAttributes),\n            inputTranscript: await (0, utils_2.unGzipBase64AsJson)(data.inputTranscript),\n            audioStream: data.audioStream\n                ? await (0, utils_2.convert)(data.audioStream)\n                : undefined,\n        };\n    }\n    /**\n     * handle client's `RecognizeTextCommand`\n     * used for sending simple text message\n     */\n    async _handleRecognizeTextCommand(botConfig, data, baseParams, client) {\n        logger.debug('postText to lex2', data);\n        const params = {\n            ...baseParams,\n            text: data,\n        };\n        try {\n            const recognizeTextCommand = new client_lex_runtime_v2_1.RecognizeTextCommand(params);\n            const resultData = await client.send(recognizeTextCommand);\n            this._reportBotStatus(resultData, botConfig);\n            return resultData;\n        }\n        catch (err) {\n            return Promise.reject(err);\n        }\n    }\n    /**\n     * handle client's `RecognizeUtteranceCommand`\n     * used for obj text or obj voice message\n     */\n    async _handleRecognizeUtteranceCommand(botConfig, data, baseParams, client) {\n        const { content, options: { messageType }, } = data;\n        logger.debug('postContent to lex2', data);\n        let params;\n        // prepare params\n        if (messageType === 'voice') {\n            if (typeof content !== 'object') {\n                return Promise.reject(new Error('invalid content type'));\n            }\n            const inputStream = content instanceof Uint8Array ? content : await (0, utils_2.convert)(content);\n            params = {\n                ...baseParams,\n                requestContentType: 'audio/x-l16; sample-rate=16000; channel-count=1',\n                inputStream,\n            };\n        }\n        else {\n            // text input\n            if (typeof content !== 'string')\n                return Promise.reject(new Error('invalid content type'));\n            params = {\n                ...baseParams,\n                requestContentType: 'text/plain; charset=utf-8',\n                inputStream: content,\n            };\n        }\n        // make API call to lex\n        try {\n            const recognizeUtteranceCommand = new client_lex_runtime_v2_1.RecognizeUtteranceCommand(params);\n            const resultData = await client.send(recognizeUtteranceCommand);\n            const response = await this._formatUtteranceCommandOutput(resultData);\n            this._reportBotStatus(response, botConfig);\n            return response;\n        }\n        catch (err) {\n            return Promise.reject(err);\n        }\n    }\n}\nexports.lexProvider = new AWSLexV2Provider();\n"],"names":[],"mappings":"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"}