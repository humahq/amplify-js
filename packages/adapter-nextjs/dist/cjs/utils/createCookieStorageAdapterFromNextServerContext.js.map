{"version":3,"file":"createCookieStorageAdapterFromNextServerContext.js","sources":["../../../src/utils/createCookieStorageAdapterFromNextServerContext.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.createCookieStorageAdapterFromNextServerContext = exports.DATE_IN_THE_PAST = void 0;\nconst server_js_1 = require(\"next/server.js\");\nconst adapter_core_1 = require(\"@aws-amplify/core/internals/adapter-core\");\nexports.DATE_IN_THE_PAST = new Date(0);\nconst createCookieStorageAdapterFromNextServerContext = (context) => {\n    const { request: req, response: res } = context;\n    // When the server context is from `getServerSideProps`, the `req` is an instance\n    // of IncomingMessage, and the `res` is an instance of ServerResponse.\n    // We cannot import these two classes here from `http` as it breaks in Next\n    // Edge Runtime. Hence, we check the methods that we need to use for creating\n    // cookie adapter.\n    if (req &&\n        res &&\n        Object.prototype.toString.call(req.cookies) === '[object Object]' &&\n        typeof res.setHeader === 'function') {\n        return createCookieStorageAdapterFromGetServerSidePropsContext(req, res);\n    }\n    const { request, response } = context;\n    // When the server context is from `middleware`, the `request` is an instance\n    // of `NextRequest`.\n    // When the server context is from a route handler, the `request` is an `Proxy`\n    // wrapped `Request`.\n    // The `NextRequest` and the `Proxy` are sharing the same interface by Next\n    // implementation. So we don't need to detect the difference.\n    if (request && response) {\n        if (response instanceof server_js_1.NextResponse) {\n            return createCookieStorageAdapterFromNextRequestAndNextResponse(request, response);\n        }\n        else {\n            return createCookieStorageAdapterFromNextRequestAndHttpResponse(request, response);\n        }\n    }\n    const { cookies } = context;\n    if (typeof cookies === 'function') {\n        return createCookieStorageAdapterFromNextCookies(cookies);\n    }\n    // This should not happen normally.\n    throw new adapter_core_1.AmplifyServerContextError({\n        message: 'Attempted to create cookie storage adapter from an unsupported Next.js server context.',\n    });\n};\nexports.createCookieStorageAdapterFromNextServerContext = createCookieStorageAdapterFromNextServerContext;\nconst createCookieStorageAdapterFromNextRequestAndNextResponse = (request, response) => {\n    const readonlyCookieStore = request.cookies;\n    const mutableCookieStore = response.cookies;\n    return {\n        get(name) {\n            return readonlyCookieStore.get(ensureEncodedForJSCookie(name));\n        },\n        getAll: readonlyCookieStore.getAll.bind(readonlyCookieStore),\n        set(name, value, options) {\n            mutableCookieStore.set(ensureEncodedForJSCookie(name), value, options);\n        },\n        delete(name) {\n            mutableCookieStore.delete(ensureEncodedForJSCookie(name));\n        },\n    };\n};\nconst createCookieStorageAdapterFromNextRequestAndHttpResponse = (request, response) => {\n    const readonlyCookieStore = request.cookies;\n    const mutableCookieStore = createMutableCookieStoreFromHeaders(response.headers);\n    return {\n        get(name) {\n            return readonlyCookieStore.get(ensureEncodedForJSCookie(name));\n        },\n        getAll: readonlyCookieStore.getAll.bind(readonlyCookieStore),\n        ...mutableCookieStore,\n    };\n};\nconst createCookieStorageAdapterFromNextCookies = (cookies) => {\n    const cookieStore = cookies();\n    // When Next cookies() is called in a server component, it returns a readonly\n    // cookie store. Hence calling set and delete throws an error. However,\n    // cookies() returns a mutable cookie store when called in a server action.\n    // We have no way to detect which one is returned, so we try to call set and delete\n    // and safely ignore the error if it is thrown.\n    const setFunc = (name, value, options) => {\n        try {\n            cookieStore.set(ensureEncodedForJSCookie(name), value, options);\n        }\n        catch {\n            // no-op\n        }\n    };\n    const deleteFunc = name => {\n        try {\n            cookieStore.delete(ensureEncodedForJSCookie(name));\n        }\n        catch {\n            // no-op\n        }\n    };\n    return {\n        get(name) {\n            return cookieStore.get(ensureEncodedForJSCookie(name));\n        },\n        getAll: cookieStore.getAll.bind(cookieStore),\n        set: setFunc,\n        delete: deleteFunc,\n    };\n};\nconst createCookieStorageAdapterFromGetServerSidePropsContext = (request, response) => {\n    const cookiesMap = { ...request.cookies };\n    const allCookies = Object.entries(cookiesMap).map(([name, value]) => ({\n        name,\n        value,\n    }));\n    return {\n        get(name) {\n            const value = cookiesMap[ensureEncodedForJSCookie(name)];\n            return value\n                ? {\n                    name,\n                    value,\n                }\n                : undefined;\n        },\n        getAll() {\n            return allCookies;\n        },\n        set(name, value, options) {\n            const encodedName = ensureEncodedForJSCookie(name);\n            const existingValues = getExistingSetCookieValues(response.getHeader('Set-Cookie'));\n            // if the cookies have already been set, we don't need to set them again.\n            if (existingValues.findIndex(cookieValue => cookieValue.startsWith(`${encodedName}=`) &&\n                !cookieValue.startsWith(`${encodedName}=;`)) > -1) {\n                return;\n            }\n            response.appendHeader('Set-Cookie', `${encodedName}=${value};${options ? serializeSetCookieOptions(options) : ''}`);\n        },\n        delete(name) {\n            const encodedName = ensureEncodedForJSCookie(name);\n            const setCookieValue = `${encodedName}=;Expires=${exports.DATE_IN_THE_PAST.toUTCString()}`;\n            const existingValues = getExistingSetCookieValues(response.getHeader('Set-Cookie'));\n            // if the value for cookie deletion is already in the Set-Cookie header, we\n            // don't need to add the deletion value again.\n            if (existingValues.includes(setCookieValue)) {\n                return;\n            }\n            response.appendHeader('Set-Cookie', setCookieValue);\n        },\n    };\n};\nconst createMutableCookieStoreFromHeaders = (headers) => {\n    const setFunc = (name, value, options) => {\n        headers.append('Set-Cookie', `${ensureEncodedForJSCookie(name)}=${value};${options ? serializeSetCookieOptions(options) : ''}`);\n    };\n    const deleteFunc = name => {\n        headers.append('Set-Cookie', `${ensureEncodedForJSCookie(name)}=;Expires=${exports.DATE_IN_THE_PAST.toUTCString()}`);\n    };\n    return {\n        set: setFunc,\n        delete: deleteFunc,\n    };\n};\nconst serializeSetCookieOptions = (options) => {\n    const { expires, domain, httpOnly, sameSite, secure, path } = options;\n    const serializedOptions = [];\n    if (domain) {\n        serializedOptions.push(`Domain=${domain}`);\n    }\n    if (expires) {\n        serializedOptions.push(`Expires=${expires.toUTCString()}`);\n    }\n    if (httpOnly) {\n        serializedOptions.push(`HttpOnly`);\n    }\n    if (sameSite) {\n        serializedOptions.push(`SameSite=${sameSite}`);\n    }\n    if (secure) {\n        serializedOptions.push(`Secure`);\n    }\n    if (path) {\n        serializedOptions.push(`Path=${path}`);\n    }\n    return serializedOptions.join(';');\n};\n// Ensures the cookie names are encoded in order to look up the cookie store\n// that is manipulated by js-cookie on the client side.\n// Details of the js-cookie encoding behavior see:\n// https://github.com/js-cookie/js-cookie#encoding\n// The implementation is borrowed from js-cookie without escaping `[()]` as\n// we are not using those chars in the auth keys.\nconst ensureEncodedForJSCookie = (name) => encodeURIComponent(name).replace(/%(2[346B]|5E|60|7C)/g, decodeURIComponent);\nconst getExistingSetCookieValues = (values) => values === undefined ? [] : Array.isArray(values) ? values : [String(values)];\n"],"names":[],"mappings":"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"}